{% extends "base.html" %}
{% load formatters %}

{% block title %}Contratos | Sistema Tibau do Sul{% endblock %}

{% block content %}
<header class="page-intro">
  <h1>Contratos</h1>
  <p>Analise contratual por empresa, modalidade e faixa de valor.</p>
</header>

{% if insights %}
<div class="insights-box">
  <h2>Insights automaticos</h2>
  <ul>
    {% for item in insights %}
    <li>{{ item }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<div class="export-bar">
  <a class="link-btn" href="/api/contratacoes/contratos/?export=csv&search={{ search }}&empresa={{ empresa }}&modalidade={{ modalidade }}&valor_min={{ valor_min }}&valor_max={{ valor_max }}&ordering={{ ordering }}">Exportar CSV</a>
</div>

<section class="panel">
  <div class="grid grid-3">
    <article class="kpi">
      <div class="label">Total filtrado</div>
      <div class="v">{{ resumo.total_filtrado|currency_brl }}</div>
    </article>
    <article class="kpi">
      <div class="label">Quantidade</div>
      <div class="v">{{ resumo.quantidade }}</div>
    </article>
    <article class="kpi accent">
      <div class="label">Ticket medio</div>
      <div class="v">{{ resumo.ticket_medio|currency_brl }}</div>
    </article>
  </div>
</section>

<section class="panel">
  <form method="get" class="filter-grid">
    <div>
      <label for="contratos-search" class="sr-only">Busca textual</label>
      <input id="contratos-search" type="text" name="search" placeholder="Busca textual" value="{{ search }}">
    </div>
    <div>
      <label for="contratos-empresa" class="sr-only">Empresa</label>
      <input id="contratos-empresa" type="text" name="empresa" placeholder="Empresa" value="{{ empresa }}">
    </div>
    <div>
      <label for="contratos-modalidade" class="sr-only">Modalidade</label>
      <input id="contratos-modalidade" type="text" name="modalidade" placeholder="Modalidade" value="{{ modalidade }}">
    </div>
    <div>
      <label for="contratos-valor-min" class="sr-only">Valor minimo</label>
      <input id="contratos-valor-min" type="number" step="0.01" name="valor_min" placeholder="Valor minimo" value="{{ valor_min }}">
    </div>
    <div>
      <label for="contratos-valor-max" class="sr-only">Valor maximo</label>
      <input id="contratos-valor-max" type="number" step="0.01" name="valor_max" placeholder="Valor maximo" value="{{ valor_max }}">
    </div>
    <div>
      <label for="contratos-ordering" class="sr-only">Ordenacao</label>
      <select id="contratos-ordering" name="ordering">
        <option value="-valor" {% if ordering == '-valor' %}selected{% endif %}>Maior valor</option>
        <option value="valor" {% if ordering == 'valor' %}selected{% endif %}>Menor valor</option>
        <option value="empresa" {% if ordering == 'empresa' %}selected{% endif %}>Empresa A-Z</option>
        <option value="-empresa" {% if ordering == '-empresa' %}selected{% endif %}>Empresa Z-A</option>
      </select>
    </div>
    <button type="submit">Filtrar</button>
  </form>
</section>

<section class="panel">
  <div class="table-wrap">
    <table>
      <thead><tr><th>Numero</th><th>Empresa</th><th class="hide-mobile">CNPJ</th><th>Modalidade</th><th>Valor</th><th>Data Assinatura</th><th>Ativo</th><th>Objeto</th></tr></thead>
      <tbody>
        {% for item in page_obj %}
        <tr>
          <td>{{ item.numero }}</td>
          <td class="cell-text">{{ item.empresa }}</td>
          <td class="hide-mobile">{{ item.cnpj|default:"-" }}</td>
          <td><span class="badge">{{ item.modalidade }}</span></td>
          <td class="num">{{ item.valor|currency_brl }}</td>
          <td>{{ item.data_assinatura|date:"d/m/Y"|default:"-" }}</td>
          <td>
            {% if item.ativo %}
            <span class="badge success">Ativo</span>
            {% else %}
            <span class="badge danger">Encerrado</span>
            {% endif %}
          </td>
          <td class="cell-text">{{ item.objeto|truncatechars:120 }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="8">Nenhum contrato encontrado.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if page_obj.paginator.num_pages > 1 %}
  <nav class="pagination">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}&search={{ search }}&empresa={{ empresa }}&modalidade={{ modalidade }}&valor_min={{ valor_min }}&valor_max={{ valor_max }}&ordering={{ ordering }}">Anterior</a>
    {% endif %}
    <span class="info">Pagina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}&search={{ search }}&empresa={{ empresa }}&modalidade={{ modalidade }}&valor_min={{ valor_min }}&valor_max={{ valor_max }}&ordering={{ ordering }}">Proxima</a>
    {% endif %}
  </nav>
  {% endif %}
</section>
{% endblock %}
