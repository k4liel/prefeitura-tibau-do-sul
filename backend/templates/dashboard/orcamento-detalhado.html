{% extends "base.html" %}
{% load formatters %}

{% block title %}Orcamento Detalhado | Sistema Tibau do Sul{% endblock %}

{% block content %}
<header class="page-intro">
  <h1>Orcamento Detalhado</h1>
  <p>Painel dedicado para acompanhamento da dotacao inicial, atualizada e saldo disponivel.</p>
</header>

{% if insights %}
<div class="insights-box">
  <h2>Insights automaticos</h2>
  <ul>
    {% for item in insights %}
    <li>{{ item }}</li>
    {% endfor %}
  </ul>
</div>
{% endif %}

<section class="panel">
  <div class="grid">
    <article class="kpi">
      <div class="label">Registros</div>
      <div class="v">{{ resumo.quantidade }}</div>
    </article>
    <article class="kpi">
      <div class="label">Orcamento inicial</div>
      <div class="v">{{ resumo.inicial|currency_brl }}</div>
    </article>
    <article class="kpi accent">
      <div class="label">Orcamento atualizado</div>
      <div class="v">{{ resumo.atualizado|currency_brl }}</div>
    </article>
    <article class="kpi success">
      <div class="label">Saldo disponivel</div>
      <div class="v">{{ resumo.disponivel|currency_brl }}</div>
    </article>
  </div>
</section>

<section class="panel">
  <form method="get" class="filter-grid">
    <div>
      <label for="orcamento-search" class="sr-only">Busca (unidade/acao)</label>
      <input id="orcamento-search" type="text" name="search" placeholder="Busca por unidade ou acao" value="{{ search }}">
    </div>
    <div>
      <label for="orcamento-funcao" class="sr-only">Funcao</label>
      <select id="orcamento-funcao" name="funcao">
        <option value="">Todas as funcoes</option>
        {% for f in funcoes %}
        <option value="{{ f }}" {% if funcao == f %}selected{% endif %}>{{ f }}</option>
        {% endfor %}
      </select>
    </div>
    <button type="submit">Filtrar</button>
  </form>
</section>

<section class="panel">
  <h2>Detalhamento orcamentario</h2>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Unidade</th>
          <th>Acao</th>
          <th>Funcao</th>
          <th class="hide-mobile">Subfuncao</th>
          <th class="hide-mobile">Elemento Despesa</th>
          <th>Valor Inicial</th>
          <th>Valor Atualizado</th>
          <th>Valor Disponivel</th>
        </tr>
      </thead>
      <tbody>
        {% for item in page_obj %}
        <tr>
          <td class="cell-text" data-label="Unidade">{{ item.unidade|default:"-" }}</td>
          <td class="cell-text" data-label="Acao">{{ item.acao|default:"-"|truncatechars:110 }}</td>
          <td data-label="Funcao"><span class="badge accent">{{ item.funcao|default:"-" }}</span></td>
          <td class="hide-mobile" data-label="Subfuncao">{{ item.subfuncao|default:"-" }}</td>
          <td class="hide-mobile" data-label="Elemento Despesa">{{ item.elemento_despesa|default:"-" }}</td>
          <td class="num" data-label="Valor Inicial">{{ item.valor_inicial|currency_brl }}</td>
          <td class="num" data-label="Valor Atualizado">{{ item.valor_atualizado|currency_brl }}</td>
          <td class="num" data-label="Valor Disponivel">{{ item.valor_disponivel|currency_brl }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="8">Sem dados de orcamento detalhado disponiveis.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% if page_obj.paginator.num_pages > 1 %}
  <nav class="pagination">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}&search={{ search }}&funcao={{ funcao }}">Anterior</a>
    {% endif %}
    <span class="info">Pagina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}&search={{ search }}&funcao={{ funcao }}">Proxima</a>
    {% endif %}
  </nav>
  {% endif %}
</section>
{% endblock %}
